keyop_core.cpp rewrite finished.
